name: ERP Auto Deploy (IIS + Node + Python + NSSM)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # -------------------------------------------------
      # 0Ô∏è‚É£ CLEAN OLD WORKSPACE (CRITICAL)
      # -------------------------------------------------
      - name: Clean runner workspace
        shell: powershell
        run: |
          Write-Host "Cleaning old workspace..."
          if (Test-Path "$env:GITHUB_WORKSPACE") {
            Get-ChildItem "$env:GITHUB_WORKSPACE" -Force | Remove-Item -Recurse -Force
          }

      # -------------------------------------------------
      # 1Ô∏è‚É£ CAPTURE JOB START TIME (IST)
      # -------------------------------------------------
      - name: Capture Job Start Time (IST)
        shell: powershell
        run: |
          $ist = Get-Date
          $log = "D:\Action-Runners\erp-runner\_diag\job-runtime-IST.log"
          "START | $($ist.ToString('yyyy-MM-dd HH:mm:ss')) | Repo=$env:GITHUB_REPOSITORY | RunId=$env:GITHUB_RUN_ID" | Out-File -Append $log

      # -------------------------------------------------
      # 2Ô∏è‚É£ CHECKOUT SOURCE (FORCE CLEAN)
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # -------------------------------------------------
      # 3Ô∏è‚É£ SETUP NODE.JS
      # -------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------
      # 4Ô∏è‚É£ SYNC BACKEND CODE TO IIS
      # -------------------------------------------------
      - name: Sync backend code to IIS
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE\backend"
          $dest = "C:\inetpub\wwwroot\YJKerp\server"

          if (!(Test-Path $src)) {
            Write-Error "Backend source folder not found"
            exit 1
          }

          robocopy $src $dest /MIR /XD node_modules
          if ($LASTEXITCODE -le 7) { exit 0 } else { exit $LASTEXITCODE }

      # -------------------------------------------------
      # 5Ô∏è‚É£ INSTALL NODE BACKEND DEPENDENCIES
      # -------------------------------------------------
      - name: Install Node backend dependencies
        shell: powershell
        run: |
          cd C:\inetpub\wwwroot\YJKerp\server
          if (Test-Path node_modules) {
            Remove-Item -Recurse -Force node_modules
          }
          npm ci --legacy-peer-deps

      # -------------------------------------------------
      # 6Ô∏è‚É£ INSTALL PYTHON BACKEND DEPENDENCIES
      # -------------------------------------------------
      - name: Install Python backend dependencies
        shell: powershell
        run: |
          $python = "C:\Users\saraswathi.pv\AppData\Local\Programs\Python\Python311\python.exe"
          $appDir = "C:\inetpub\wwwroot\YJKerp\server\python"

          cd $appDir

          & $python -m pip install --upgrade pip

          if (Test-Path "requirements.txt") {
            & $python -m pip install -r requirements.txt
          }
          else {
            Write-Error "requirements.txt not found"
            exit 1
          }

      # -------------------------------------------------
      # 7Ô∏è‚É£ RESTART NODE BACKEND (NSSM)
      # -------------------------------------------------
      - name: Restart Node backend (NSSM)
        shell: powershell
        run: |
          $serviceName = "ERP"
          $nssm = "C:\Windows\System32\nssm.exe"
          $node = "C:\Program Files\nodejs\node.exe"
          $app = "C:\inetpub\wwwroot\YJKerp\server\https.js"
          $appDir = "C:\inetpub\wwwroot\YJKerp\server"

          if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
            Write-Host "Restarting Node service..."
            & $nssm restart $serviceName
          }
          else {
            Write-Host "Creating Node NSSM service..."
            & $nssm install $serviceName $node $app
            & $nssm set $serviceName AppDirectory $appDir
            & $nssm set $serviceName Start SERVICE_AUTO_START
            & $nssm set $serviceName AppStdout "$appDir\node-out.log"
            & $nssm set $serviceName AppStderr "$appDir\node-err.log"
            & $nssm start $serviceName
          }

      # -------------------------------------------------
      # 8Ô∏è‚É£ RESTART PYTHON BACKEND (NSSM)
      # -------------------------------------------------
      - name: Restart Python backend (NSSM)
        shell: powershell
        run: |
          $serviceName = "ERP_PY"
          $nssm = "C:\Windows\System32\nssm.exe"
          $python = "C:\Users\saraswathi.pv\AppData\Local\Programs\Python\Python311\python.exe"
          $app = "C:\inetpub\wwwroot\YJKerp\server\python\face_recognition_api.py"
          $appDir = "C:\inetpub\wwwroot\YJKerp\server\python"

          if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
            Write-Host "Restarting Python service..."
            & $nssm restart $serviceName
          }
          else {
            Write-Host "Creating Python NSSM service..."
            & $nssm install $serviceName $python $app
            & $nssm set $serviceName AppDirectory $appDir
            & $nssm set $serviceName Start SERVICE_AUTO_START
            & $nssm set $serviceName AppStdout "$appDir\py-out.log"
            & $nssm set $serviceName AppStderr "$appDir\py-err.log"
            & $nssm start $serviceName
          }

      # -------------------------------------------------
      # 9Ô∏è‚É£ INSTALL FRONTEND DEPENDENCIES
      # -------------------------------------------------
      - name: Install frontend dependencies
        shell: powershell
        run: |
          if (Test-Path node_modules) {
            Remove-Item -Recurse -Force node_modules
          }
          npm ci --legacy-peer-deps

      # -------------------------------------------------
      # üîü BUILD FRONTEND
      # -------------------------------------------------
      - name: Build frontend
        shell: powershell
        run: |
          $env:CI="false"
          $env:GENERATE_SOURCEMAP="false"
          npm run build

      # -------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ DEPLOY FRONTEND TO IIS
      # -------------------------------------------------
      - name: Deploy frontend to IIS
        shell: powershell
        run: |
          robocopy build C:\inetpub\wwwroot\YJKerp\build /MIR /XF web.config
          if ($LASTEXITCODE -le 7) { exit 0 } else { exit $LASTEXITCODE }

      # -------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ CAPTURE JOB END TIME (IST)
      # -------------------------------------------------
      - name: Capture Job End Time (IST)
        if: always()
        shell: powershell
        run: |
          $ist = Get-Date
          $log = "D:\Action-Runners\erp-runner\_diag\job-runtime-IST.log"
          "END | $($ist.ToString('yyyy-MM-dd HH:mm:ss')) | Repo=$env:GITHUB_REPOSITORY | RunId=$env:GITHUB_RUN_ID | Status=${{ job.status }}" | Out-File -Append $log
